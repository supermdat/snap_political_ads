---
title: "ASNAP Political Data"
output: html_notebook
---


## Setup    
  Load the relevant libraries.
```{r message=TRUE, warning=TRUE}

rm(list = ls())
# .rs.restartR()


# data munging
library("tidyverse")
library("data.table")
# library("tidyquant")    # rolling calculations


# other
library("skimr")          # data investigation
library("rlang")          # creating functions

# munge dates
library("lubridate")


# viz
library("scales")
library("plotly")




library("tictoc")

# get tweets
# library("rtweet")

# NLP
# library("tidytext")
# library("syuzhet")
# library("googleLanguageR")

# graph analyses
# library("tidygraph")
# library("ggraph")

# # feature engineering and data prep
# library("recipes")
# library("caret")
# library("DMwR")
# 
# # to explore missing data
# library("visdat")
# library("naniar")
# 
# # modeling
# library("h2o")

```
  
    
  Session Info.
```{r}

sessionInfo()

```


  Setup the root directory.
```{r "setup", include = FALSE}

require("knitr")


# Use when running from AWS
# opts_knit$set(root.dir = "/home/rstudio/Dropbox/_AWS/snap_political_ads")


# Use when running from laptop
opts_knit$set(root.dir = "/Users/mdturse/Desktop/Analytics/snap_political_ads")

```
  
    
  Setting `wd` as the working directory.
```{r}

wd <- getwd()

wd

```


## Get the Data  
  
  Unzip and read the .csv files.
```{r}
# url examples
# https://storage.googleapis.com/ad-manager-political-ads-dump/political/2018/PoliticalAds.zip
# https://storage.googleapis.com/ad-manager-political-ads-dump/political/2019/PoliticalAds.zip

years <- c("2018", "2019")

url_prefix <- "https://storage.googleapis.com/ad-manager-political-ads-dump/political/"
url_suffix <- "/PoliticalAds.zip"


for(i in years) {
  # create a temporary directory
  td = tempdir()
  
  # create the placeholder file
  tf = tempfile(tmpdir = td, fileext = ".zip")
  
  # download into the placeholder file
  download.file(url = paste0(url_prefix, i, url_suffix),
                destfile = tf
                )
  
  # get the name of the first file in the zip archive
  name_csv = unzip(tf, list = TRUE)$Name[1]
  name_readme = unzip(tf, list = TRUE)$Name[2]
  
  # unzip the file to the temporary directory
  unzip(tf,
        # files = name_csv,
        exdir = td,
        overwrite = TRUE
        )
  
  # fpath is the full path to the extracted file
  path_csv = file.path(td, name_csv)
  # path_readme = file.path(td, name_readme)
  
  assign(x = paste0("data_", i),
         value = read_csv(file = path_csv)
         )
  }

message("data_2018")
glimpse(data_2018)

message("data_2019")
glimpse(data_2019)


rm(years, i, td, tf, path_csv)
rm(list = ls(pattern = "url_"))
rm(list = ls(pattern = "name_"))

```
  
  Update variable names.
```{r}

data_2018 <-
  data_2018 %>% 
  rename_all(~str_replace_all(.x,
                              "\\W",
                              "_"
                              )
             ) %>% 
  rename_all(tolower)

data_2019 <-
  data_2019 %>% 
  rename_all(~str_replace_all(.x,
                              "\\W",
                              "_"
                              )
             ) %>% 
  rename_all(tolower)


message("data_2018")
glimpse(data_2018)

message("data_2019")
glimpse(data_2019)

```
  
    
  Compare if the column names are the same
```{r}

ncol(data_2018)
ncol(data_2019)

setdiff(colnames(data_2018),
        colnames(data_2019)
        )

```
  
    
  Bind the rows to create a single dataset.
```{r}

data_20182019 <-
  bind_rows(data_2018 %>% mutate(data_yr = 2018),
            data_2019 %>% mutate(data_yr = 2019)
            ) %>% 
  mutate(startdate = as_datetime(startdate),
         enddate = as_datetime(enddate),
         ad_delivery_interval = interval(start = startdate,
                                         end = enddate
                                         ),
         ad_delivery_duration_sec = ad_delivery_interval %>% int_length(),
         ad_delivery_duration_day = ad_delivery_interval / ddays(x = 1)
         ) %>% 
  select(-ad_delivery_interval,
         -ad_delivery_duration_sec
         )
  

write_rds(x = data_20182019,
          path = paste0(wd,
                        "/Data/Interim/",
                        "data_20182019.rds"
                        )
          )


glimpse(data_20182019)
data_20182019 %>% 
  mutate_if(is.character, factor) %>% 
  mutate_if(is.factor, factor) %>% 
  skim()


View(data_20182019 %>% filter(spend <= 0))
View(data_20182019 %>% filter(ad_delivery_duration_day <= 0))
View(data_20182019 %>% filter(is.na(enddate)))




ids <-
  data_2018 %>% 
  head(10) %>% 
  pull(adid)

# View(data_2018 %>% 
#        filter(adid %in% ids) %>% 
#        select(adid,
#               startdate,
#               enddate
#               ) %>% 
#        arrange(adid)
#      )
# 
# View(data_20182019 %>% 
#        filter(adid %in% ids) %>% 
#        select(adid,
#               startdate,
#               enddate
#               ) %>% 
#        arrange(adid)
#      )

rm(data_2018, data_2019)

```
  
    
  Create the function `func_unnest_dt` based on `data.table` as using `unnest` is extremely slow for variables with many values (e.g., `postal_codes__included__long` and `postal_codes__excluded__long`). See: [https://www.johannesbgruber.eu/post/a-faster-unnest/](https://www.johannesbgruber.eu/post/a-faster-unnest/)
```{r}

func_unnest_dt <-
  function(tbl, ...) {
    
    tbl = as.data.table(tbl)
    
    col = ensyms(...)
    
    clnms = syms(setdiff(colnames(tbl),
                         as.character(col)
                         )
                 )
    
    tbl = as.data.table(tbl)
    
    tbl = eval(expr(tbl[ ,
                        lapply(.SD, unlist),
                        by = list(!!!clnms),
                        .SDcols = as.character(col)
                        ]
                    )
               )
    
    colnames(tbl) = c(as.character(clnms),
                      as.character(col)
                      )
    
    return(tbl)
    }

```
  
    
  Make the data "tidy" - i.e., one row per `interests` and one row per `targeting_geo___postal_code` (instead of having list-columns as in the original data).
```{r}

# data_20182019 %>% count(postal_codes__included_) %>% View()

tic()
data_20182019_long <-
  data_20182019 %>% 
  mutate(interests_long = str_split(interests,
                                    ",",
                                    ),
         language_long = str_split(language,
                                   ",",
                                   ),
         advanced_demographics_long = str_split(advanceddemographics,
                                                ",",
                                                ),
         regions__included__long = str_split(regions__included_,
                                             ",",
                                             ),
         regions__excluded__long = str_split(regions__excluded_,
                                             ",",
                                             ),
         electoral_districts__included__long = str_split(electoral_districts__included_,
                                             ",",
                                             ),
         electoral_districts__excluded__long = str_split(electoral_districts__excluded_,
                                             ",",
                                             ),
         metros__included__long = str_split(metros__included_,
                                             ",",
                                             ),
         metros__excluded__long = str_split(metros__excluded_,
                                             ",",
                                             ),
         postal_codes__included__long = str_split(postal_codes__included_,
                                             ",",
                                             ),
         postal_codes__excluded__long = str_split(postal_codes__excluded_,
                                             ",",
                                             ),
         location_categories__included__long = str_split(location_categories__included_,
                                             ",",
                                             ),
         location_categories__excluded__long = str_split(location_categories__excluded_,
                                             ",",
                                             )
         # targeting_geo___postal_code_long = str_split(targeting_geo___postal_code,
         #                                              ",",
         #                                              )
         ) %>% 
  # unnest(cols = c(interests_long,
  #                 language_long,
  #                 advanced_demographics_long,
  #                 regions__included__long,
  #                 regions__excluded__long,
  #                 electoral_districts__included__long,
  #                 electoral_districts__excluded__long,
  #                 metros__included__long,
  #                 metros__excluded__long,
  #                 postal_codes__included__long,
  #                 postal_codes__excluded__long,
  #                 location_categories__included__long,
  #                 location_categories__excluded__long
  #                 )
  #        ) %>%
  # 6104.941 sec elapsed 1 hr 42 min
  # tic("postal_codes__included__long")
  # unnest(postal_codes__included__long) %>%
  # # 
  # # tic("postal_codes__excluded__long")
  # unnest(postal_codes__excluded__long) %>%
  # # 
  # tic("interests_long")
  # unnest(interests_long) %>%
  # func_unnest_dt(interests_long) %>% 
  # # 
  # # tic("language_long")
  # unnest(language_long) %>%
  # # 
  # # tic("advanced_demographics_long")
  # unnest(advanced_demographics_long) %>%
  # #
  # # tic("regions__included__long")
  # unnest(regions__included__long) %>%
  # #
  # # tic("regions__excluded__long")
  # unnest(regions__excluded__long) %>%
  # #
  # # tic("electoral_districts__included__long")
  # unnest(electoral_districts__included__long) %>%
  # #
  # # tic("electoral_districts__excluded__long")
  # unnest(electoral_districts__excluded__long) %>%
  # #
  # # tic("metros__included__long")
  # unnest(metros__included__long) %>%
  # #
  # # tic("metros__excluded__long")
  # unnest(metros__excluded__long) %>%
  # # 
  # # tic("location_categories__included__long")
  # unnest(location_categories__included__long) %>%
  # # 
  # # tic("location_categories__excluded__long")
  # unnest(location_categories__excluded__long) %>%
  

  # unnest(targeting_geo___postal_code_long) %>% 
  # arrange(adid)
  # tic("as.data.table")
  as.data.table() %>% 
    
  # tic("adid")
  setkey(adid)
toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()


# write_rds(x = data_20182019_long,
#           path = paste0(wd,
#                         "/Data/Interim/",
#                         "data_20182019_long.rds"
#                         )
#           )


dim(data_20182019)
dim(data_20182019_long)

class(data_20182019_long)
glimpse(data_20182019_long)
# View(data_20182019_long %>% head(1000))



# View(data_20182019 %>%
#        filter(adid %in% ids) %>%
#        select(adid,
#               interests,
#               targeting_geo___postal_code
#               ) %>%
#        arrange(adid)
#      )
# 
# View(data_20182019_long %>%
#        filter(adid %in% ids) %>%
#        select(adid,
#               interests,
#               interests_long,
#               # targeting_geo___postal_code,
#               # targeting_geo___postal_code_long
#               ) %>%
#        arrange(adid)
#      )


# rm(data_20182019, ids)

```


```{r}

test <-
  data_20182019_long %>% 
  select(adid,
         creativeurl,
         interests_long,
         language_long
         ) %>% 
  as.data.table() %>% 
  setkey(adid)

class(test)
glimpse(test)

# test_unnest <-
#   test[ ,
#        list(interests_long = as.character(unlist(interests_long)
#                                           )
#             ),
#        by = list(adid, creativeurl)
#        ]
# 
# class(test_unnest)
# glimpse(test_unnest)

View(test %>% head(1000))
# View(test_unnest %>% head(1000))


test_unnest_func <-
  func_unnest_dt(tbl = test,
                 interests_long,
                 language_long
                 )

class(test_unnest_func)
glimpse(test_unnest_func)

# View(test %>% head(1000))
View(test_unnest_func %>% head(1000))

```



```{r}

DT <- data.table(
  a = LETTERS[1:5],
  b = LETTERS[6:10],
  list_column1 = list(c(LETTERS[1:5]), "F", "G", "H", "I"),
  list_column2 = list("A", "B", "C", "D", c(LETTERS[5:9]))
)

DT

func_unnest_dt(DT, list_column1, list_column2)

```


```{r}

unnest_dt <- function(tbl, col) {

  tbl <- as.data.table(tbl)

  col <- ensyms(col)

  clnms <- syms(setdiff(colnames(tbl), as.character(col)))

  tbl <- as.data.table(tbl)

  tbl <- eval(
    expr(tbl[ ,
             as.character(unlist(!!!col)
                          ),
             by = list(!!!clnms)
             ]
         )
    )

  colnames(tbl) <- c(as.character(clnms), as.character(col))

  tbl
}

```


```{r}

test2 <-
  unnest_dt(tbl = test,
          col = interests_long
          )

class(test2)
glimpse(test2)

```







## Variable Exploration
```{r}

dim(data_20182019_long)
data_20182019_long %>% 
  mutate_if(is.character, factor) %>% 
  mutate_if(is.factor, factor) %>% 
  skim()

```

    
  Inspect individual variables.
```{r}

vars_num_wide <-
  data_20182019_long %>% 
  mutate(ad_delivery_interval = interval(start = startdate,
                                         end = enddate
                                         ),
         ad_delivery_duration_sec = ad_delivery_interval %>% int_length(),
         ad_delivery_duration_day = ad_delivery_interval / ddays(x = 1)
         ) %>% 
  select(-ad_delivery_interval,
         -ad_delivery_duration_sec
         ) %>% 
  mutate_if(is.character, factor) %>% 
  mutate_if(is.factor, factor)

glimpse(vars_num_wide)
dim(vars_num_wide)
vars_num_wide %>% skim()

nrow_clean <-
  vars_num_wide %>% 
  filter(spend > 0 &
           ad_delivery_duration_day > 0
         ) %>% 
  nrow()

nrow_all <-
  vars_num_wide %>% nrow()

nrow_clean
nrow_all
nrow_clean / nrow_all


rm(list = ls(pattern = "nrow_"))

View(vars_num_wide %>% filter(ad_delivery_duration_day <= 0))
View(vars_num_wide %>% filter(is.na(enddate)))



vars_num_long <-
  vars_num_wide %>% 
  select_if(is.numeric) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "value"
               ) %>% 
  # group_by(variable) %>% 
  # nest() 
  split(.$variable)

glimpse(vars_num_long$ad_delivery_duration_day)
vars_num_long %>% map(~skim(.x))


# rm(vars_num_wide)

```


```{r}

# vars_num_hist <-
#   vars_num_long %>% 
#   mutate(hist = map(data,
#                     ~ggplot(data = .x,
#                             aes(x = value)
#                             ) +
#                       geom_histogram() +
#                       theme_minimal() +
#                       NULL
#                     ),
#          freq = map(data,
#                     ~ggplot(data = .x,
#                             aes(x = value)
#                             ) +
#                       geom_freqpoly() +
#                       theme_minimal() +
#                       # labs(title = paste0("Histogram of ",
#                       #                     variable
#                       #                     )
#                       #      ) +
#                       NULL
#                     )
#          )
# 
# glimpse(vars_num_hist)
# vars_num_hist$hist
# vars_num_hist$freq

```



```{r}

vars_num_hist_freq <-
  pmap(.l = list(a = vars_num_long,
                 b = names(vars_num_long)
                 ),
       .f = function(a, b) {
         plot_basic =
           a %>% 
           # ggplot(aes(#x = log1p(value)
           #            x = value
           #            ),
           #        ) +
           ggplot() +
           theme_minimal() +
           # scale_x_continuous(labels = comma,
           #                    trans = scales::log1p_trans()
           #                    ) +
           # labs(x = paste0("Log of ", b)
           #      ) +
           NULL
         
         hist =
           plot_basic +
           geom_histogram(aes(x = value),
                          na.rm = TRUE,
                          bins = 50
                          ) +
           scale_x_continuous(labels = comma#,
                              # trans = scales::log1p_trans()
                              ) +
           labs(title = paste0("Histogram of ",
                               b
                               ),
                subtitle = "logged values",
                x = b
                )
         
         freq =
           plot_basic +
           geom_freqpoly(aes(x = value),
                         na.rm = TRUE,
                         bins = 50
                         ) +
           scale_x_continuous(labels = comma#,
                              # trans = scales::log1p_trans()
                              ) +
           labs(title = paste0("Freqpoly of ",
                               b
                               ),
                subtitle = "logged values",
                x = b
                )
         
         box =
           plot_basic +
           geom_boxplot(aes(y = value),
                        na.rm = TRUE,
                        outlier.color = "red"
                        ) +
           scale_y_continuous(labels = comma#,
                              # trans = scales::log1p_trans()
                              ) +
           labs(title = paste0("Boxplot of ",
                               b
                               ),
                subtitle = "logged values",
                x = b
                )
         
         # return(list(hist = hist,
         #             freq = freq,
         #             box = box
         #             )
         #        )
         return(list(hist = ggplotly(hist),
                     freq = ggplotly(freq),
                     box = ggplotly(box)
                     )
                )
         }
       )

vars_num_hist_freq


rm(vars_num_hist_freq)

```



## Minor Feature Engineering  
  
  Creating new features.
```{r}

add_features <-
  vars_num_wide %>% 
  mutate(cost_per_impression = spend / impressions,
         impressions_per_dollar = impressions / spend,
         # ad_delivery_interval = interval(start = startdate,
         #                                 end = enddate
         #                                 ),
         # ad_delivery_duration_sec = ad_delivery_interval %>% int_length(),
         # ad_delivery_duration_day = ad_delivery_interval / ddays(x = 1),
         start_date = as_date(startdate),
         start_date_yrmth = floor_date(startdate, unit = "month"),
         end_date = as_date(enddate),
         end_date_yrmth = floor_date(enddate, unit = "month"),
         impressions_per_day = impressions / ad_delivery_duration_day,
         impressions_per_day_per_dollar = impressions_per_day / spend
         )

glimpse(add_features)


View(add_features %>% head(1000))

# View(add_features %>% 
#        select(startdate,
#               enddate,
#               ad_delivery_duration_sec,
#               ad_delivery_duration_day,
#               start_date,
#               start_date_yrmth,
#               end_date
#               ) %>%
#        head(100)
#      )


rm(data_20182019_long)

```
  

```{r}

View(add_features %>% 
  count(interests_long,
        sort = TRUE
        )
  )

View(add_features %>% 
  mutate(interests_long_lump = fct_lump(f = interests_long,
                                        prop = 0.01,
                                        # n = 20,
                                        other_level = "_Other"
                                        )
         ) %>% 
  count(interests_long_lump,
        sort = TRUE
        )
  )

```


```{r}

smry <-
  add_features %>% 
  select_if(is.character) %>% 
  mutate_all(factor) %>% 
  skim()

str(smry)
smry
# View(smry %>% as.data.frame())



chr_cols <-
  add_features %>% 
  select_if(is.character) %>% 
  colnames()

names(chr_cols) <- chr_cols
# str(chr_cols)


cnt_within_chr_cols <-
  pmap(.l = list(a = chr_cols
                 ),
       .f = function(a) { #, b) {
         quo_a = enquo(a)
         
         data_count = add_features %>% 
           count(!!!rlang::parse_exprs(a),
                 sort = TRUE,
                 name = "cnt_n"
                 ) %>% 
           mutate(is_na = if_else(is.na(!!!rlang::parse_exprs(a)
                                        ),
                                  0,
                                  1
                                  )
                  ) %>% 
           arrange(desc(is_na),
                   desc(cnt_n)
                   ) %>% 
           mutate(cnt_n_cumsum = cumsum(cnt_n),
                  cnt_pct = cnt_n / sum(cnt_n),
                  cnt_pct_cumsum = cumsum(cnt_pct),
                  row_num = row_number(),
                  row_num_pct = row_num / max(row_num)
                  )
         
         return(data_count)
         }
       )

cnt_within_chr_cols
# cnt_within_chr_cols$interests_long

```


