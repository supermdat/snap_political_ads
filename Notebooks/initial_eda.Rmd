---
title: 'SNAP Political Data'
author: "M Daniel A Turse"
date: "2020-02-06"
output:
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    toc: yes
    latex_engine: xelatex
---




## Setup (This is all something I would do at the beginning of each .Rmd file)  

Install needed packages.
```{r message=FALSE, warning=FALSE}

# clear out anything in the working environment
rm(list = ls())
# .rs.restartR()


##################################
##  Install Packages from CRAN  ##
##################################
list_of_packages <-
  c("tidyverse",
    "data.table",
    "lubridate",
    # "broom",
    "plotly",
    "scales",
    "rsample",
    # "recipes",
    # "caret",
    # "DMwR",
    # "randomForest",
    # "glmnet",
    # "h2o",
    # "nnet",
    "skimr",
    "naniar",
    "tictoc",
    "furrr",
    "doParallel",
    "rlang",
    "tmap",
    "tidycensus",
    "sf"#,
    # "tsibble",
    # "feasts",
    # "e1071"
    )

new_packages <-
  list_of_packages[!(list_of_packages %in% installed.packages()[ , "Package"]
                     )
                   ]

if(length(new_packages)) install.packages(new_packages)


####################################
##  Install Packages from GitHub  ##
####################################

if(!require(devtools)
   ) {install.packages("devtools")}

if(!("BRRR" %in% installed.packages()[, "Package"]
     )
   ) {devtools::install_github("brooke-watson/BRRR")}


rm(list = ls(pattern = "packages"))

```


Load the relevant libraries.
```{r message=FALSE, warning=FALSE}


# data munging
library("tidyverse")      # general data manipulation
library("data.table")     # general data manipulation
library("lubridate")      # date specific munging
# library("broom")          # cleanly obtain results from models


# viz
library("plotly")         # interactive plots
library("scales")         # prettier scales


# modeling
library("rsample")        # sampling and modeling infrastructure
library("recipes")        # modeling infrastructure
# library("caret")          # modeling infrastructure


# spatial data
library("tmap")
library("tidycensus")
library("sf")


# other
library("skimr")          # inspect data
library("naniar")         # inspect missingness of data
library("tictoc")         # easy runtime calcs
library("furrr")          # run `purrr` in parallel
library("rlang")          # writing functions
# library("tsibble")        # time series
# library("feasts")         # time series
library("BRRR")           # hip-hop notifications of when code finishes :- )

```
  
    
Session Info.
```{r}

sessionInfo()

```


Play this .wav file when there is an error
```{r include = FALSE}

options(error = function() {skrrrahh("khaled2")})

```
  

  Setup the root directory.
```{r setup, include=FALSE}

require("knitr")


# # Use when running from AWS
# # opts_knit$set(root.dir = "/home/rstudio/Dropbox/_AWS/snap_political_ads")


# # Use when running from laptop
opts_knit$set(root.dir = "/Users/mdturse/Desktop/Analytics/snap_political_ads")

```
  
    
  Setting `wd` as the working directory.
```{r}
wd <- getwd()

wd

```


## Get the Data  
  
  Unzip and read the .csv files.
```{r}

# url examples
# https://storage.googleapis.com/ad-manager-political-ads-dump/political/2018/PoliticalAds.zip
# https://storage.googleapis.com/ad-manager-political-ads-dump/political/2019/PoliticalAds.zip


years <- c("2018", "2019", "2020")
url_prefix <- "https://storage.googleapis.com/ad-manager-political-ads-dump/political/"
url_suffix <- "/PoliticalAds.zip"


for(i in years) {
  # create a temporary directory
  td = tempdir()
  
  # create the placeholder file
  tf = tempfile(tmpdir = td, fileext = ".zip")
  
  # download into the placeholder file
  download.file(url = paste0(url_prefix, i, url_suffix),
                destfile = tf
                )
  
  # get the name of the first file in the zip archive
  name_csv = unzip(tf, list = TRUE)$Name[1]
  name_readme = unzip(tf, list = TRUE)$Name[2]
  
  # unzip the file to the temporary directory
  unzip(tf,
        # files = name_csv,
        exdir = td,
        overwrite = TRUE
        )
  
  # fpath is the full path to the extracted file
  path_csv = file.path(td, name_csv)
  # path_readme = file.path(td, name_readme)
  
  assign(x = paste0("data_", i, "_raw"),
         value = read_csv(file = path_csv,
                          col_types = cols(ADID = col_character(),
                                           CreativeUrl = col_character(),
                                           `Currency Code` = col_character(),
                                           Spend = col_double(),
                                           Impressions = col_double(),
                                           # StartDate = col_datetime(format = ""),
                                           # EndDate = col_datetime(format = ""),
                                           StartDate = col_character(),
                                           EndDate = col_character(),
                                           OrganizationName = col_character(),
                                           BillingAddress = col_character(),
                                           CandidateBallotInformation = col_character(),
                                           PayingAdvertiserName = col_character(),
                                           Gender = col_character(),
                                           AgeBracket = col_character(),
                                           CountryCode = col_character(),
                                           `Regions (Included)` = col_character(),
                                           `Regions (Excluded)` = col_character(),
                                           `Electoral Districts (Included)` = col_character(),
                                           `Electoral Districts (Excluded)` = col_character(),
                                           `Radius Targeting (Included)` = col_character(),
                                           `Radius Targeting (Excluded)` = col_character(),
                                           `Metros (Included)` = col_character(),
                                           `Metros (Excluded)` = col_character(),
                                           `Postal Codes (Included)` = col_character(),
                                           `Postal Codes (Excluded)` = col_character(),
                                           `Location Categories (Included)` = col_character(),
                                           `Location Categories (Excluded)` = col_character(),
                                           Interests = col_character(),
                                           OsType = col_character(),
                                           Segments = col_character(),
                                           Language = col_character(),
                                           AdvancedDemographics = col_character(),
                                           `Targeting Connection Type` = col_character(),
                                           `Targeting Carrier (ISP)` = col_character(),
                                           CreativeProperties = col_character()
                                           )
                          )
         )
}


message("data_2018_raw")
glimpse(data_2018_raw)
message("data_2019_raw")
glimpse(data_2019_raw)
message("data_2020_raw")
glimpse(data_2020_raw)


rm(years, i, td, tf, path_csv)
rm(list = ls(pattern = "url_"))
rm(list = ls(pattern = "name_"))

```
  
    
  Update variable names.
```{r}

data_2018 <-
  data_2018_raw %>% 
  rename_all(~str_replace_all(.x,
                              "\\W",
                              "_"
                              )
             ) %>% 
  rename_all(tolower)

data_2019 <-
  data_2019_raw %>% 
  rename_all(~str_replace_all(.x,
                              "\\W",
                              "_"
                              )
             ) %>% 
  rename_all(tolower)

data_2020 <-
  data_2020_raw %>% 
  rename_all(~str_replace_all(.x,
                              "\\W",
                              "_"
                              )
             ) %>% 
  rename_all(tolower)


message("data_2018")
glimpse(data_2018)
message("data_2019")
glimpse(data_2019)
message("data_2020")
glimpse(data_2020)


rm(list = ls(pattern = "_raw"))

```
  
    
  Compare if the column names are the same
```{r}

ncol(data_2018)
ncol(data_2019)
ncol(data_2020)

setdiff(colnames(data_2018),
        colnames(data_2019)
        )

setdiff(colnames(data_2018),
        colnames(data_2020)
        )

```
  
    
  Bind the rows to create a single dataset.
```{r}

data_20182019 <-
  bind_rows(data_2018 %>% mutate(data_yr = 2018),
            data_2019 %>% mutate(data_yr = 2019),
            data_2020 %>% mutate(data_yr = 2020)
            ) %>% 
  mutate(startdate = as_datetime(startdate),
         enddate = as_datetime(enddate),
         ad_delivery_interval = interval(start = startdate,
                                         end = enddate
                                         ),
         ad_delivery_duration_sec = ad_delivery_interval %>% int_length(),
         ad_delivery_duration_day = ad_delivery_interval / ddays(x = 1),
         impressions_per_USD = if_else(spend > 0,
                                       impressions / spend,
                                       as.numeric(NA)
                                       ),
         impressions_per_day = impressions / ad_delivery_duration_day
         ) %>% 
  select(-ad_delivery_interval,
         -ad_delivery_duration_sec
         )
  
# write_rds(x = data_20182019,
#           path = paste0(wd,
#                         "/Data/Interim/",
#                         "data_20182019.rds"
#                         )
#           )

glimpse(data_20182019)

data_20182019 %>%
  mutate_if(is.character, factor) %>%
  mutate_if(is.factor, factor) %>%
  skim()
skrrrahh()

# View(data_20182019 %>% filter(spend <= 0))
# View(data_20182019 %>% filter(ad_delivery_duration_day <= 0))
# View(data_20182019 %>% filter(is.na(enddate)))


ids <-
  data_2018 %>% 
  head(10) %>% 
  pull(adid)

# View(data_2018 %>% 
#        filter(adid %in% ids) %>% 
#        select(adid,
#               startdate,
#               enddate
#               ) %>% 
#        arrange(adid)
#      )
# 
# View(data_20182019 %>% 
#        filter(adid %in% ids) %>% 
#        select(adid,
#               startdate,
#               enddate
#               ) %>% 
#        arrange(adid)
#      )


rm(data_2018, data_2019, data_2020)

```
  
    
  Create the function `func_unnest_dt` based on `data.table` as using `unnest` is extremely slow for variables with many values (e.g., `postal_codes__included__long` and `postal_codes__excluded__long`). See: [https://www.johannesbgruber.eu/post/a-faster-unnest/](https://www.johannesbgruber.eu/post/a-faster-unnest/)
```{r}
# func_unnest_dt <-
#   function(tbl, ...) {
#     
#     tbl = as.data.table(tbl)
#     
#     col = ensyms(...)
#     
#     clnms = syms(setdiff(colnames(tbl),
#                          as.character(col)
#                          )
#                  )
#     
#     tbl = as.data.table(tbl)
#     
#     tbl = eval(expr(tbl[ ,
#                         lapply(.SD, unlist),
#                         by = list(!!!clnms),
#                         .SDcols = as.character(col)
#                         ]
#                     )
#                )
#     
#     colnames(tbl) = c(as.character(clnms),
#                       as.character(col)
#                       )
#     
#     return(tbl)
#     }
```
  
    
  Make the data "tidy" - i.e., one row per `interests` and one row per `targeting_geo___postal_code` (instead of having list-columns as in the original data).
```{r}
# data_20182019 %>% count(postal_codes__included_) %>% View()
tic()
data_20182019_long <-
  data_20182019 %>% 
  mutate(interests_long = str_split(interests,
                                    ",",
                                    ),
         language_long = str_split(language,
                                   ",",
                                   ),
         advanced_demographics_long = str_split(advanceddemographics,
                                                ",",
                                                ),
         regions__included__long = str_split(regions__included_,
                                             ",",
                                             ),
         regions__excluded__long = str_split(regions__excluded_,
                                             ",",
                                             ),
         electoral_districts__included__long = str_split(electoral_districts__included_,
                                             ",",
                                             ),
         electoral_districts__excluded__long = str_split(electoral_districts__excluded_,
                                             ",",
                                             ),
         metros__included__long = str_split(metros__included_,
                                             ",",
                                             ),
         metros__excluded__long = str_split(metros__excluded_,
                                             ",",
                                             ),
         postal_codes__included__long = str_split(postal_codes__included_,
                                             ",",
                                             ),
         postal_codes__excluded__long = str_split(postal_codes__excluded_,
                                             ",",
                                             ),
         location_categories__included__long = str_split(location_categories__included_,
                                             ",",
                                             ),
         location_categories__excluded__long = str_split(location_categories__excluded_,
                                             ",",
                                             )
         
         
         # targeting_geo___postal_code_long = str_split(targeting_geo___postal_code,
         #                                              ",",
         #                                              )
         ) %>% 
  # unnest(cols = c(interests_long,
  #                 language_long,
  #                 advanced_demographics_long,
  #                 regions__included__long,
  #                 regions__excluded__long,
  #                 electoral_districts__included__long,
  #                 electoral_districts__excluded__long,
  #                 metros__included__long,
  #                 metros__excluded__long,
  #                 postal_codes__included__long,
  #                 postal_codes__excluded__long,
  #                 location_categories__included__long,
  #                 location_categories__excluded__long
  #                 )
  #        ) %>%
  # 6104.941 sec elapsed 1 hr 42 min
  #  # tic("postal_codes__included__long")
  #  unnest(postal_codes__included__long) %>%
  #   
  #   # tic("postal_codes__excluded__long")
  #  unnest(postal_codes__excluded__long) %>%
  #   
  #  # tic("interests_long")
  #  unnest(interests_long) %>%
  #  func_unnest_dt(interests_long) %>% 
  #   
  #   # tic("language_long")
  #  unnest(language_long) %>%
  #   
  #   # tic("advanced_demographics_long")
  #  unnest(advanced_demographics_long) %>%
  #  
  #   # tic("regions__included__long")
  #  unnest(regions__included__long) %>%
  #  
  #   # tic("regions__excluded__long")
  #  unnest(regions__excluded__long) %>%
  #  
  #   # tic("electoral_districts__included__long")
  #  unnest(electoral_districts__included__long) %>%
  #  
  #   # tic("electoral_districts__excluded__long")
  #  unnest(electoral_districts__excluded__long) %>%
  #  
  #   # tic("metros__included__long")
  #  unnest(metros__included__long) %>%
  #  
  #   # tic("metros__excluded__long")
  #  unnest(metros__excluded__long) %>%
  #   
  #   # tic("location_categories__included__long")
  #  unnest(location_categories__included__long) %>%
  #   
  #   # tic("location_categories__excluded__long")
  #  unnest(location_categories__excluded__long) %>%
  # 
  #  # unnest(targeting_geo___postal_code_long) %>% 
  # # arrange(adid)
  # tic("as.data.table")
  as.data.table() %>% 
    
  # tic("adid")
  setkey(adid)
toc()
skrrrahh()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# toc()
# write_rds(x = data_20182019_long,
#           path = paste0(wd,
#                         "/Data/Interim/",
#                         "data_20182019_long.rds"
#                         )
#           )
dim(data_20182019)
dim(data_20182019_long)
class(data_20182019_long)
glimpse(data_20182019_long)
# View(data_20182019_long %>% head(1000))
# View(data_20182019 %>%
#        filter(adid %in% ids) %>%
#        select(adid,
#               interests,
#               targeting_geo___postal_code
#               ) %>%
#        arrange(adid)
#      )
# 
# View(data_20182019_long %>%
#        filter(adid %in% ids) %>%
#        select(adid,
#               interests,
#               interests_long,
#               # targeting_geo___postal_code,
#               # targeting_geo___postal_code_long
#               ) %>%
#        arrange(adid)
#      )
# rm(data_20182019, ids)
```


```{r}
# test <-
#   data_20182019_long %>% 
#   select(adid,
#          # creativeurl,
#          interests_long,
#          language_long
#          ) %>% 
#   as.data.table() %>% 
#   setkey(adid)
# 
# 
# class(test)
# glimpse(test)
```



```{r}
# test_unnest_interests <-
#   test[ ,
#        list(
#             interests_long = as.character(unlist(interests_long)
#                                           )
#             # language_long = as.character(unlist(language_long)
#             #                               )
#             ),
#        by = list(adid#,
#                  # creativeurl
#                  )
#        ]
# 
# 
# test_unnest_language <-
#   test[ ,
#        list(
#             # interests_long = as.character(unlist(interests_long)
#             #                               ),
#             language_long = as.character(unlist(language_long)
#                                           )
#             ),
#        by = list(adid#,
#                  # creativeurl
#                  )
#        ]
# 
# 
# message("test_unnest_interests")
# class(test_unnest_interests)
# glimpse(test_unnest_interests)
# 
# message("test_unnest_language")
# class(test_unnest_language)
# glimpse(test_unnest_language)
# 
# 
# View(test %>% head(1000))
# View(test %>% filter(!is.na(interests_long) & !is.na(language_long)))
# View(test_unnest_interests %>% head(1000))
# View(test_unnest_language %>% head(1000))
```


```{r}
# test_full_join <-
#   test_unnest_interests %>% 
#   full_join(y = test_unnest_language,
#             by = c("adid" = "adid"#,
#                    # "creativeurl" = "creativeurl"
#                    )
#             ) %>% 
#   arrange(adid)
# 
# View(test_full_join %>% head(1000))
# View(test_full_join %>% filter(adid == "82108d4e8b8e53d651443d6f5a128c2dbca1347bbb2c4fbd6c2e49dfc6d2269a"))
```



```{r}
# var_names <-
#   c("interests_long",
#     "language_long",
#     "advanced_demographics_long",
#     "regions__included__long",
#     "regions__excluded__long",
#     "electoral_districts__included__long",
#     "electoral_districts__excluded__long",
#     "metros__included__long",
#     "metros__excluded__long",
#     "postal_codes__included__long",
#     "postal_codes__excluded__long",
#     "location_categories__included__long",
#     "location_categories__excluded__long"
#   )
# 
# var_names_quo <-
#   var_names %>% 
#   map(~quo(.x))
# 
# 
# test_map <-
#   pmap(.l = list(#a = var_names[1:2],
#                  b = var_names_quo
#                  ),
#        .f = function(#a,
#                      b
#                      ) {
#          dat =
#            test[ ,
#                 list(b = as.character(unlist(b)
#                                       )
#                      ),
#                 by = list(adid)
#                 ]
#          }
#        )
```
  
    
  Unlist the list-colums...unfortunately, doing this one-by-one (i.e. **manually**) with `data.table` as `tidyr::unnest` was too slow and creating a function with `data.table` was not working right. **I should revisit writing the function later.**
```{r}
# tic()
start <- proc.time()
unlist_interests_long <-
  data_20182019_long[ ,
                      list(interests_long = as.character(unlist(interests_long)
                                                         )
                           ),
                      by = list(adid)
                      ]
unlist_language_long <-
  data_20182019_long[ ,
                      list(language_long = as.character(unlist(language_long)
                                                        )
                           ),
                      by = list(adid)
                      ]
unlist_advanced_demographics_long <-
  data_20182019_long[ ,
                      list(advanced_demographics_long = as.character(unlist(advanced_demographics_long)
                                                                     )
                           ),
                      by = list(adid)
                      ]
unlist_regions__included__long <-
  data_20182019_long[ ,
                      list(regions__included__long = as.character(unlist(regions__included__long)
                                                                  )
                           ),
                      by = list(adid)
                      ]
unlist_regions__excluded__long <-
  data_20182019_long[ ,
                      list(regions__excluded__long = as.character(unlist(regions__excluded__long)
                                                                  )
                           ),
                      by = list(adid)
                      ]
unlist_electoral_districts__included__long <-
  data_20182019_long[ ,
                      list(electoral_districts__included__long = as.character(unlist(electoral_districts__included__long)
                                                                              )
                           ),
                      by = list(adid)
                      ]
unlist_electoral_districts__excluded__long <-
  data_20182019_long[ ,
                      list(electoral_districts__excluded__long = as.character(unlist(electoral_districts__excluded__long)
                                                                              )
                           ),
                      by = list(adid)
                      ]
unlist_metros__included__long <-
  data_20182019_long[ ,
                      list(metros__included__long = as.character(unlist(metros__included__long)
                                                                 )
                           ),
                      by = list(adid)
                      ]
unlist_metros__excluded__long <-
  data_20182019_long[ ,
                      list(metros__excluded__long = as.character(unlist(metros__excluded__long)
                                                                 )
                           ),
                      by = list(adid)
                      ]
unlist_postal_codes__included__long <-
  data_20182019_long[ ,
                      list(postal_codes__included__long = as.character(unlist(postal_codes__included__long)
                                                                       )
                           ),
                      by = list(adid)
                      ]
unlist_postal_codes__excluded__long <-
  data_20182019_long[ ,
                      list(postal_codes__excluded__long = as.character(unlist(postal_codes__excluded__long)
                                                                       )
                           ),
                      by = list(adid)
                      ]
unlist_location_categories__included__long <-
  data_20182019_long[ ,
                      list(location_categories__included__long = as.character(unlist(location_categories__included__long)
                                                                              )
                           ),
                      by = list(adid)
                      ]
unlist_location_categories__excluded__long <-
  data_20182019_long[ ,
                      list(location_categories__excluded__long = as.character(unlist(location_categories__excluded__long)
                                                                              )
                           ),
                      by = list(adid)
       ]

# toc()
end <- proc.time() - start
end
skrrrahh()
# glimpse(data_20182019_long)


rm(start, end)

```
  
    
  Now join all the columns to create a singular "tidy" dataset.
```{r}

# tic()
start <- proc.time()
join_unlisted_data <-
  data_20182019_long %>% 
  select(adid:impressions_per_day) %>% 
  distinct() %>% 
  merge(y = unlist_interests_long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_language_long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_advanced_demographics_long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_regions__included__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_regions__excluded__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_electoral_districts__included__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_electoral_districts__excluded__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_metros__included__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_metros__excluded__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_postal_codes__included__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_postal_codes__excluded__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_location_categories__included__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  merge(y = unlist_location_categories__excluded__long,
        by = "adid",
        all = TRUE,
        allow.cartesian = TRUE
        ) %>% 
  mutate_if(is.character, factor) %>% 
  mutate_if(is.factor, factor) %>% 
  as.data.table() %>% 
  setkey(adid)
# toc()

end <- proc.time() - start
end
skrrrahh()
  
class(join_unlisted_data)
glimpse(join_unlisted_data)
skim(join_unlisted_data)

# View(join_unlisted_data %>% head(1000))


rm(list = ls(pattern = "unlist_"))
rm(start, end)

```


```{r}

join_unlisted_data %>% count(countrycode, sort = TRUE)

us_only <-
  join_unlisted_data %>% 
  filter(countrycode == "united states")

# skim(us_only$ad_delivery_duration_day)


data_20182019 %>% count(adid) %>% filter(n != 1)
data_20182019_long %>% count(adid) %>% filter(n != 1)


us_only %>% select(adid) %>% distinct() %>% nrow()

us_only %>% 
  filter(ad_delivery_duration_day < 0) %>% 
  select(adid) %>% 
  distinct() %>% 
  nrow()

us_only %>% 
  filter(ad_delivery_duration_day >= 0) %>% 
  select(adid) %>% 
  distinct() %>% 
  nrow()

us_only %>% 
  filter(is.na(ad_delivery_duration_day)
         ) %>% 
  select(adid) %>% 
  distinct() %>% 
  nrow()


negative_ad_duration <-
  us_only %>% 
  select(adid,
         ad_delivery_duration_day
         ) %>% 
  distinct() %>% 
  filter(ad_delivery_duration_day < 0) %>% 
  pull(adid)

# View(us_only %>% 
#        filter(adid %in% negative_ad_duration) %>% 
#        select(!dplyr::ends_with("long")) %>% 
#        distinct()
#      )

us_only_no_duration_neg <-
  us_only %>% 
  filter(!(adid %in% negative_ad_duration)
         ) #%>% 
  # select(adid) %>% 
  # distinct() %>% 
  # nrow()

us_only_no_duration_neg_skim <-
  us_only_no_duration_neg %>% 
  skim()

# us_only_skim


vars_abv_pt5_missing <-
  us_only_no_duration_neg_skim %>% 
  filter(complete_rate > 0.05) %>% 
  pull(skim_variable)

us_only_no_duration_neg %>% 
  select(-one_of(vars_abv_pt5_missing)
         ) %>% 
  colnames()

us_only_vars_abv_pt5_missing <-
  us_only_no_duration_neg %>% 
  select(one_of(vars_abv_pt5_missing)
         ) %>% 
  distinct() %>% 
  mutate_if(is.factor, factor)

str(us_only_vars_abv_pt5_missing)
skim(us_only_vars_abv_pt5_missing)

# View(us_only_vars_abv_pt5_missing %>% 
#        head(1000)
#      )


rm(negative_ad_duration, us_only_no_duration_neg, vars_abv_pt5_missing)

```



```{r}

many_impressions <-
  us_only_vars_abv_pt5_missing %>% 
  arrange(desc(impressions_per_day)) %>% 
  select(-dplyr::contains("_long")
         ) %>% 
  distinct() %>% 
  head(100)

write_csv(x = many_impressions,
          path = paste0(wd,
                        # "/Data/Interim/",
                        "/",
                        "many_impressions.csv"
                        )
          )

View(many_impressions)

```



```{r}

View(us_only_vars_abv_pt5_missing %>% 
       arrange(spend) %>% 
       head(1000)
     )

us_only_vars_abv_pt5_missing %>% skim(spend)

```



```{r}

v17 <- load_variables(2017, "acs5", cache = TRUE)

View(v17)

```



```{r}

# edu_dc <-
#   get_acs(geography = "tract",
#           state = "DC",
#           # variables = c(education = "B99151_001",
#           #               med_house_income = "B19013_001",
#           #               population = "H0100001"
#           #               ),
#           # variables = c("B99151_001",
#           #               "B19013_001",
#           #               "H0100001"
#           #               ),
#           variables = "B19013_001",
#           year = 2017,
#           geometry = TRUE,
#           key = Sys.getenv("CENSUS_KEY")
#           )
# 
# edu_dc
# 
# 
# edu_dc2 <-
#   get_acs(geography = "tract",
#           state = "DC",
#           # variables = c(education = "B99151_001",
#           #               med_house_income = "B19013_001",
#           #               population = "H0100001"
#           #               ),
#           # variables = c("B99151_001",
#           #               "B19013_001",
#           #               "H0100001"
#           #               ),
#           variables = "B99151_001",
#           year = 2017,
#           geometry = FALSE,
#           key = Sys.getenv("CENSUS_KEY")
#           )
# 
# edu_dc2


census_all_data_zcta <-
  get_acs(# geography = "tract",
          geography = "zcta",
          # state = "DC",
          # variables = c(education = "B99151_001",
          #               med_house_income = "B19013_001",
          #               population = "H0100001"
          #               ),
          # variables = c("B99151_001",
          #               "B19013_001",
          #               "H0100001"
          #               ),
          variables = c(population = "B01001_001",
                        bachelor_plus = "B99151_001",
                        med_house_income = "B19013_001"
                        ),
          year = 2017,
          geometry = TRUE,
          key = Sys.getenv("CENSUS_API_KEY")#,
          # options(tigris_use_cache = TRUE)
          )

# usethis::edit_r_environ()

census_all_data_zcta
# census_all_data_zcta[ , c("GEOID", "variable")] %>% count(GEOID, variable, sort = TRUE)

```



```{r}

census_all_data_zcta_wide <-
  census_all_data_zcta %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  pivot_wider(names_from = variable,
              values_from = c(estimate, moe)
              ) %>% 
  mutate(estimate_bachelor_plus_pct = estimate_bachelor_plus / estimate_population)
  # sf::spread.sf(key = variable,
  #           value = estimate
  #           ) 

glimpse(census_all_data_zcta_wide)
skim(census_all_data_zcta_wide)
census_all_data_zcta_wide

```



```{r}

ad_cnt_by_zip <-
  us_only_vars_abv_pt5_missing %>% 
  filter(!is.na(postal_codes__included__long)
         ) %>% 
  count(postal_codes__included__long,
        name = "pol_ad_cnt",
        sort = TRUE
        ) %>% 
  mutate(postal_codes__included__long = as.character(postal_codes__included__long)
         )

geoid_geom <- census_all_data_zcta[ , c("GEOID", "geometry")]


census_wide_with_geom <-
  geoid_geom %>% 
  left_join(y = census_all_data_zcta_wide,
            by = "GEOID"
            ) %>% 
  left_join(y = ad_cnt_by_zip,
            by = c("GEOID" = "postal_codes__included__long")
            )
  

glimpse(census_wide_with_geom)

```



```{r}

twos <-
  census_wide_with_geom %>% 
  filter(str_detect(string = GEOID,
                    pattern = "200\\d{2}"
                    )
         )


plot(twos["estimate_med_house_income"])
plot(twos["estimate_bachelor_plus_pct"])


twos %>% 
  ggplot() +
  geom_sf(aes(fill = estimate_med_house_income)
          ) +
  theme_minimal()

census_all_data_zcta %>% 
  filter(str_detect(string = GEOID,
                    pattern = "200\\d{2}"
                    )
         ) %>% 
  ggplot() +
  geom_sf(aes(fill = estimate)
          ) +
  facet_wrap(~ variable
             # scales = "free"
             # ncol = 1
             ) +
  theme_minimal()


## tmap mode set to interactive viewing
tmap_mode("view")

tm_shape(twos) +
  tm_fill("estimate_med_house_income",
          palette = sf.colors(5)
          )

tm_shape(twos) +
  tm_fill("estimate_bachelor_plus_pct",
          palette = sf.colors(5)
          )

```


```{r}

zips_with_ads <-
  census_wide_with_geom %>% 
  filter(!is.na(pol_ad_cnt)
         )

glimpse(zips_with_ads)

```


```{r}

tm_shape(zips_with_ads) +
  tm_fill("pol_ad_cnt",
          palette = sf.colors(5)
          )

tm_shape(zips_with_ads) +
  tm_fill("estimate_bachelor_plus_pct",
          palette = sf.colors(5)
          )

```




```{r}
# # tic()
# start <- proc.time()
# join_unlisted_data2 <-
#   data_20182019_long %>% 
#   select(adid:ad_delivery_duration_day) %>% 
#   distinct() %>% 
#   full_join(y = unlist_interests_long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_language_long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_advanced_demographics_long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_regions__included__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_regions__excluded__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_electoral_districts__included__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_electoral_districts__excluded__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_metros__included__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_metros__excluded__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_postal_codes__included__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_postal_codes__excluded__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_location_categories__included__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   full_join(y = unlist_location_categories__excluded__long,
#             by = "adid"
#             
#         
#             ) %>% 
#   mutate_if(is.character, factor) %>% 
#   mutate_if(is.factor, factor) %>% 
#   as.data.table() %>% 
#   setkey(adid)
# # toc()
# end <- proc.time() - start
# end
# 
#   
# class(join_unlisted_data2)
# glimpse(join_unlisted_data2)
# skim(join_unlisted_data2)
# 
# View(join_unlisted_data2 %>% head(1000))
# 
# 
# # rm(list = ls(pattern = "unlist_"))
# rm(start, end)
```















```{r}
# tbl = test[ ,
#            lapply(.SD, unlist),
#            by = list(adid,
#                      creativeurl
#                      ),
#            .SDcols = c("interests_long", "language_long")
#            ]
# 
# View(tbl)
# 
# 
# colnames(tbl) = c(as.character(clnms),
#                   as.character(col)
#                   )
```
  
    
  Create the function `func_unnest_dt` based on `data.table` as using `unnest` is extremely slow for variables with many values (e.g., `postal_codes__included__long` and `postal_codes__excluded__long`). See: [https://www.johannesbgruber.eu/post/a-faster-unnest/](https://www.johannesbgruber.eu/post/a-faster-unnest/)
```{r}
# func_unnest_dt <-
#   function(tbl, ...) {
#     
#     tbl = as.data.table(tbl)
#     
#     col = ensyms(...)
#     
#     clnms = syms(setdiff(colnames(tbl),
#                          as.character(col)
#                          )
#                  )
#     
#     tbl = as.data.table(tbl)
#     
#     tbl = eval(expr(tbl[ ,
#                         lapply(.SD, unlist),
#                         by = list(!!!clnms),
#                         .SDcols = as.character(col)
#                         ]
#                     )
#                )
#     
#     colnames(tbl) = c(as.character(clnms),
#                       as.character(col)
#                       )
#     
#     return(tbl)
#   }
```



```{r}
# test_unnest_func <-
#   func_unnest_dt(tbl = test,
#                  interests_long#,
#                  # language_long
#                  )
# 
# class(test_unnest_func)
# glimpse(test_unnest_func)
# 
# 
# View(test %>% head(1000))
# View(test_unnest_func %>% head(1000))
```



```{r}
# DT <- data.table(
#   a = LETTERS[1:5],
#   b = LETTERS[6:10],
#   list_column1 = list(c(LETTERS[1:5]), "F", "G", "H", "I"),
#   list_column2 = list("A", "B", "C", "D", c(LETTERS[5:9]))
# )
# 
# DT
# 
# func_unnest_dt(DT, list_column1, list_column2)
```


```{r}
# unnest_dt <- function(tbl, col) {
#   tbl <- as.data.table(tbl)
#   
#   col <- ensyms(col)
#   
#   clnms <- syms(setdiff(colnames(tbl),
#                         as.character(col)
#                         )
#                 )
#   
#   tbl <- as.data.table(tbl)
#   
#   tbl <- eval(
#     expr(tbl[ ,
#              as.character(unlist(!!!col)
#                           ),
#              by = list(!!!clnms)
#              ]
#          )
#     )
#   
#   colnames(tbl) <- c(as.character(clnms),
#                      as.character(col)
#                      )
#   
#   tbl
# }
```


```{r}
# test2 <-
#   unnest_dt(tbl = test,
#           col = interests_long
#           )
# 
# class(test2)
# glimpse(test2)
```







## Variable Exploration
```{r}
# dim(data_20182019_long)
# data_20182019_long %>% 
#   mutate_if(is.character, factor) %>% 
#   mutate_if(is.factor, factor) %>% 
#   skim()
```

    
  Inspect individual variables.
```{r}
# vars_num_wide <-
#   # data_20182019_long %>% 
#   join_unlisted_data # %>% 
#   # mutate(ad_delivery_interval = interval(start = startdate,
#   #                                        end = enddate
#   #                                        ),
#   #        ad_delivery_duration_sec = ad_delivery_interval %>% int_length(),
#   #        ad_delivery_duration_day = ad_delivery_interval / ddays(x = 1)
#   #        ) %>% 
#   # select(-ad_delivery_interval,
#   #        -ad_delivery_duration_sec
#   #        ) %>% 
#   # mutate_if(is.character, factor) %>% 
#   # mutate_if(is.factor, factor)
# glimpse(vars_num_wide)
# dim(vars_num_wide)
# vars_num_wide %>% skim()
# nrow_clean <-
#   vars_num_wide %>% 
#   filter(spend > 0 &
#            ad_delivery_duration_day > 0
#          ) %>% 
#   nrow()
# nrow_all <-
#   vars_num_wide %>% nrow()
# nrow_clean
# nrow_all
# nrow_clean / nrow_all
# rm(list = ls(pattern = "nrow_"))
# View(vars_num_wide %>% filter(ad_delivery_duration_day <= 0))
# View(vars_num_wide %>% filter(is.na(enddate)))
# vars_num_long <-
#   vars_num_wide %>% 
#   select_if(is.numeric) %>% 
#   pivot_longer(cols = everything(),
#                names_to = "variable",
#                values_to = "value"
#                ) %>% 
#   # group_by(variable) %>% 
#   # nest() 
#   split(.$variable)
# glimpse(vars_num_long$ad_delivery_duration_day)
# vars_num_long %>% map(~skim(.x))
# # rm(vars_num_wide)
```


```{r}
# vars_num_hist <-
#   vars_num_long %>% 
#   mutate(hist = map(data,
#                     ~ggplot(data = .x,
#                             aes(x = value)
#                             ) +
#                       geom_histogram() +
#                       theme_minimal() +
#                       NULL
#                     ),
#          freq = map(data,
#                     ~ggplot(data = .x,
#                             aes(x = value)
#                             ) +
#                       geom_freqpoly() +
#                       theme_minimal() +
#                       # labs(title = paste0("Histogram of ",
#                       #                     variable
#                       #                     )
#                       #      ) +
#                       NULL
#                     )
#          )
# 
# glimpse(vars_num_hist)
# vars_num_hist$hist
# vars_num_hist$freq
```



```{r}
# vars_num_hist_freq <-
#   pmap(.l = list(a = vars_num_long,
#                  b = names(vars_num_long)
#                  ),
#        .f = function(a, b) {
#          plot_basic =
#            a %>% 
#            # ggplot(aes(#x = log1p(value)
#            #            x = value
#            #            ),
#            #        ) +
#            ggplot() +
#            theme_minimal() +
#            # scale_x_continuous(labels = comma,
#            #                    trans = scales::log1p_trans()
#            #                    ) +
#            # labs(x = paste0("Log of ", b)
#            #      ) +
#            NULL
#          
#          hist =
#            plot_basic +
#            geom_histogram(aes(x = value),
#                           na.rm = TRUE,
#                           bins = 50
#                           ) +
#            scale_x_continuous(labels = comma#,
#                               # trans = scales::log1p_trans()
#                               ) +
#            labs(title = paste0("Histogram of ",
#                                b
#                                ),
#                 subtitle = "logged values",
#                 x = b
#                 )
#          
#          freq =
#            plot_basic +
#            geom_freqpoly(aes(x = value),
#                          na.rm = TRUE,
#                          bins = 50
#                          ) +
#            scale_x_continuous(labels = comma#,
#                               # trans = scales::log1p_trans()
#                               ) +
#            labs(title = paste0("Freqpoly of ",
#                                b
#                                ),
#                 subtitle = "logged values",
#                 x = b
#                 )
#          
#          box =
#            plot_basic +
#            geom_boxplot(aes(y = value),
#                         na.rm = TRUE,
#                         outlier.color = "red"
#                         ) +
#            scale_y_continuous(labels = comma#,
#                               # trans = scales::log1p_trans()
#                               ) +
#            labs(title = paste0("Boxplot of ",
#                                b
#                                ),
#                 subtitle = "logged values",
#                 x = b
#                 )
#          
#          # return(list(hist = hist,
#          #             freq = freq,
#          #             box = box
#          #             )
#          #        )
#          return(list(hist = ggplotly(hist),
#                      freq = ggplotly(freq),
#                      box = ggplotly(box)
#                      )
#                 )
#          }
#        )
# vars_num_hist_freq
# rm(vars_num_hist_freq)
```



## Minor Feature Engineering  
  
  Creating new features.
```{r}
# add_features <-
#   vars_num_wide %>% 
#   mutate(cost_per_impression = spend / impressions,
#          impressions_per_dollar = impressions / spend,
#          # ad_delivery_interval = interval(start = startdate,
#          #                                 end = enddate
#          #                                 ),
#          # ad_delivery_duration_sec = ad_delivery_interval %>% int_length(),
#          # ad_delivery_duration_day = ad_delivery_interval / ddays(x = 1),
#          start_date = as_date(startdate),
#          start_date_yrmth = floor_date(startdate, unit = "month"),
#          end_date = as_date(enddate),
#          end_date_yrmth = floor_date(enddate, unit = "month"),
#          impressions_per_day = impressions / ad_delivery_duration_day,
#          impressions_per_day_per_dollar = impressions_per_day / spend
#          )
# glimpse(add_features)
# View(add_features %>% head(1000))
# # View(add_features %>% 
# #        select(startdate,
# #               enddate,
# #               ad_delivery_duration_sec,
# #               ad_delivery_duration_day,
# #               start_date,
# #               start_date_yrmth,
# #               end_date
# #               ) %>%
# #        head(100)
# #      )
# rm(data_20182019_long)
```
  

```{r}
# View(add_features %>% 
#   count(interests_long,
#         sort = TRUE
#         )
#   )
# View(add_features %>% 
#   mutate(interests_long_lump = fct_lump(f = interests_long,
#                                         prop = 0.01,
#                                         # n = 20,
#                                         other_level = "_Other"
#                                         )
#          ) %>% 
#   count(interests_long_lump,
#         sort = TRUE
#         )
#   )
```


```{r}
# smry <-
#   add_features %>% 
#   select_if(is.character) %>% 
#   mutate_all(factor) %>% 
#   skim()
# str(smry)
# smry
# # View(smry %>% as.data.frame())
# chr_cols <-
#   add_features %>% 
#   select_if(is.character) %>% 
#   colnames()
# names(chr_cols) <- chr_cols
# # str(chr_cols)
# cnt_within_chr_cols <-
#   pmap(.l = list(a = chr_cols
#                  ),
#        .f = function(a) { #, b) {
#          quo_a = enquo(a)
#          
#          data_count = add_features %>% 
#            count(!!!rlang::parse_exprs(a),
#                  sort = TRUE,
#                  name = "cnt_n"
#                  ) %>% 
#            mutate(is_na = if_else(is.na(!!!rlang::parse_exprs(a)
#                                         ),
#                                   0,
#                                   1
#                                   )
#                   ) %>% 
#            arrange(desc(is_na),
#                    desc(cnt_n)
#                    ) %>% 
#            mutate(cnt_n_cumsum = cumsum(cnt_n),
#                   cnt_pct = cnt_n / sum(cnt_n),
#                   cnt_pct_cumsum = cumsum(cnt_pct),
#                   row_num = row_number(),
#                   row_num_pct = row_num / max(row_num)
#                   )
#          
#          return(data_count)
#          }
#        )
# cnt_within_chr_cols
# # cnt_within_chr_cols$interests_long
```



